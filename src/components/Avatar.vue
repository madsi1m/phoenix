<template>
  <component :is="type" v-if="enabled">
    <oc-avatar :width="width" :loading="loading" :src="avatarSource" :userName="userName" />
  </component>
</template>
<script>
import { mapGetters } from 'vuex'

export default {
  data () {
    return {
      /**
       * Set to object URL when loaded, or on failure, icon placeholder is shown
       */
      avatarSource: '',
      /**
       * Shows spinner in place whilst loading avatar from server
       */
      loading: true
    }
  },
  methods: {
    /**
     * Load a new avatar from this userid
     */
    setUser (userid) {
      this.loading = true
      this.avatarSource = ''
      if (!this.enabled || userid === '') {
        this.loading = false
        return
      }
      const headers = new Headers()
      const instance = this.$root.config.server || window.location.origin
      const url = instance + '/remote.php/dav/avatars/' + this.userid + '/128.png'
      if (this.$root.config.isWebComponent) {
        this.avatarSource = url
        return
      }
      headers.append('Authorization', 'Bearer ' + this.getToken)
      headers.append('X-Requested-With', 'XMLHttpRequest')
      fetch(url, { headers })
        .then(response => {
          if (response.ok) {
            return response.blob()
          }
          throw new Error('Network response was not ok.')
        })
        .then(blob => {
          this.loading = false
          this.avatarSource = window.URL.createObjectURL(blob)
        })
        .catch(error => {
          this.avatarSource = ''
          this.loading = false
          console.log('There has been a problem with your fetch operation: ', error.message)
        })
    }
  },
  watch: {
    userid: function (userid, old) {
      this.setUser(userid)
    }
  },
  mounted: function () {
    // Handled mounted situation. Userid might not be set yet so try placeholder
    if (this.userid !== '') {
      this.setUser(this.userid)
    } else {
      this.loading = false
    }
  },
  computed: {
    ...mapGetters(['getToken']),
    enabled: function () {
      return this.$root.config.enableAvatars || true
    }
  },
  props: {
    /**
     * The html element used for the avatar container.
     * `div, span`
     */
    type: {
      type: String,
      default: 'div',
      validator: value => {
        return value.match(/(div|span)/)
      }
    },
    userName: {
      type: String,
      default: ''
    },
    userid: {
      /**
       * Allow empty string to show placeholder
       */
      default: ''
    },
    width: {
      type: Number,
      required: false,
      default: 42
    }
  }
}
</script>
